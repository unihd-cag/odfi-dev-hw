#!/usr/bin/env tclsh8.5


package require odfi::tool
package require odfi::dev::hw::package


# User attribute definition
##############
odfi::dev::hw::package::attributeFunction ::output
odfi::dev::hw::package::attributeFunction ::differential
odfi::dev::hw::package::attributeFunction ::input
odfi::dev::hw::package::attributeFunction ::group
odfi::dev::hw::package::attributeFunction ::reference_voltage
odfi::dev::hw::package::attributeFunction ::termination_voltage
odfi::dev::hw::package::attributeFunction ::power

#test:
###########

odfi::dev::hw::package::part micrel_sy8932u {
        #package qfn33_16
        
        pin { Q0_p @15 } \
        {
                output
                differential
                group out0
        }
        pin { Q0_n @16 } \
        {
                output
                differential
                group out0
        }
        pin { Q1_p @1 } \
        {
                output
                differential
                group out1
        }
        pin { Q1_n @2 } \
        {
                output
                differential
                group out1
        }
        pin { Q2_p @3 } \
        {
                output
                differential
                group out2
        }
        pin { Q2_n @4 } \
        {
                output
                differential
                group out2
        }
        pin { Q3_p @5 } \
        {
                output
                differential
                group out3
        }
        pin { Q3_n @6 } \
        {
                output
                differential
                group out3
        }
        pin { EN @8 } \
        {
                input
        }
        pin { IN_p @9 } \
        {
                input
                differential
                group in0
        }
        pin { IN_n @12 } \
        {
                input
                differential
                group in0
        }
        pin { VREF_AC @10 } \
        {
                output
                reference_voltage
        }
        pin { VT @11 } \
        {
                input
                termination_voltage
        }
        pin { GND @13 } \
        {
                power
        }
        foreach pinloc { 7 14 } \
        {
                pin VCC \
                {
                        location $pinloc
                        power
                }
        }
        
        #interchangeable { out0, out1, out2, out3}
        packageInfo
}


##########################################
## CSV ###################################
#filename.package.txt oder .csv
#original:
#set csvFile [file dirname [file normalize [info script]]]/hmc_4_link_ballout.csv

#test:
#give csvFile via command line
#set filename "[lindex $argv 0]

## Curent Directory
set directories [file dirname [file normalize [info script]]]

#set directories ""
#set filelist ""
#set filelist [glob -directory [lindex $directories 0] *.package.csv]
set filelist [glob -directory $directories *.package.csv]
set filename [lindex $filelist 0]
#set csvFile "~/modules-manager/install/dev-hw/tests/package/test.package.csv"
set csvFile $filename
## Create Foot print 
odfi::dev::hw::package::Footprint footprint
footprint name [file tail $csvFile]

## Read
set f [open $csvFile]
footprint readCSV [read $f]
close $f

##Create svg
set svg [::new odfi::dev::hw::package::SVGOutput #auto ::footprint]

##Create testoutput to be an availableProducer
set test [::new odfi::dev::hw::package::TestOutput #auto ::footprint]

##Find availableProducers:
##To add a Producer type an object must be initialized and it must be a subclass of ::odfi::dev::hw::package::BaseOutputGenerator
set objects [itcl::find objects]
set producers ""
set prod ""
foreach obj $objects {
  if {[$obj info inherit] == "::odfi::dev::hw::package::BaseOutputGenerator"} {
      set prod $obj
      lappend producers [$obj info class]
   }
}
puts "available Producers: $producers"
##Create BaseOutputGenerator for different producers
#set producers [::new odfi::dev::hw::package::BaseOutputGenerator #auto ::footprint]

#### Show Statistics
########################

#puts "Size: [footprint width]x[footprint height]"
puts -nonewline "Available files (must end in package.csv): "
puts $filelist
puts -nonewline "Directories:  "
puts $directories


## Start Web Viewer
########################

## Create Application
set app [::new odfi::dev::hw::package::www::PackageWebapp #auto]
$app currentPackage ::odfi::dev::hw::package::part0
$app availablePackages ""
$app directories $directories
$app producer $prod
$app availableProducers $producers

## Create and start server

set server [new odfi::ewww::webdata::WebdataServer my_server 8888]
$server deploy $app
$server start

vwait forever
